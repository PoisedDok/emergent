# Emergent Privacy Stack

> A paranoid, God-level zero-trust mesh network, DNS sinkhole, and Tor proxy in a box.

The average "self-hosted VPN" tutorial tells you to spin up WireGuard and Pi-hole and call it a day. That is amateur hour.

The **Emergent Stack** is a fully containerized, source-compiled, zero-trust infrastructure stack. It forces all your devices into a private WireGuard mesh, sinkholes tracking requests via AdGuard and Unbound (DNS-over-TLS), and exposes a dedicated Tor proxy—*exclusively* to the encrypted mesh network.

No open ports. No cloud reliance. No supply chain attacks.

## The Architecture

1.  **Headscale (The Control Plane):** Open-source, self-hosted Tailscale control server. Handles cryptographic key exchange and assigns `100.64.x.x` IPs to your devices. It is completely out of the data path after the handshake.
2.  **Unbound (The Blind Resolver):** A recursive DNS resolver configured for DNS-over-TLS (DoT) via Cloudflare (`1.1.1.1:853`). Your ISP cannot see your DNS queries.
3.  **AdGuard Home (The Blackhole):** Sits in front of Unbound. Drops all ad, tracking, and malware requests into the void. Configured to resolve `.in-addr.arpa` queries via Headscale's MagicDNS for beautiful, per-device analytics.
4.  **Tor Proxy (The Ghost Protocol):** A dedicated Tor client providing SOCKS5 and HTTP tunnels to the `.onion` network.
5.  **Docker Socket Proxy (The Firewall):** Wraps the raw `/var/run/docker.sock` in a read-only HAProxy layer, preventing privilege escalation from compromised containers.

### Zero-Trust Binding
Crucially, AdGuard and Tor do **not** bind to `0.0.0.0`. They bind exclusively to `127.0.0.1` and your host's Tailscale VPN IP (`100.64.0.1`). If a device is not cryptographically authenticated to the VPN, these services literally do not exist to them.

---

## Prerequisites

1.  A host machine (Linux/macOS) with **Docker** and **Docker Compose** installed.
2.  **Git** installed.
3.  The host machine must have Tailscale installed and running (to act as the anchor node).

## 1-Click Deployment Guide

We use Git submodules to pull the exact source code for Headscale and AdGuard, compiling them locally to mitigate pre-built image supply chain attacks.

### 1. Clone & Setup
```bash
git clone https://github.com/PoisedDok/emergent.git
cd emergent

# Pull submodules and create necessary directories
make setup
```

### 2. Configure Environment
```bash
# Copy the example environment variables
cp .env.example .env
```
*(Optional) Edit `.env` to change the default arbitrary ports (6500-6550).*

### 3. Build & Deploy
```bash
# Build the God-level source images
make build

# Secure permissions and spin up the stack in detached mode
make up
```

---

## The `manage.sh` CLI

We wrote a custom shell script to abstract away the complexity of managing a headless Headscale instance.

### Initializing the VPN
```bash
# Creates the 'admin' namespace and generates a 24-hour auth key
./manage.sh vpn-init

# Need a new key later?
./manage.sh vpn-key
```

### Connecting Mobile Devices (iOS/Android)
1. Download the Tailscale app.
2. Run the QR generator on your host:
   ```bash
   ./manage.sh vpn-qr
   ```
3. In the Tailscale app, go to settings -> Add Account -> Custom Server -> Scan the QR code.
4. Enter the auth key generated by `vpn-init`.

### Connecting Laptops/Desktops
1. Download Tailscale for your OS.
2. Run the login command pointing to your host IP:
   ```bash
   tailscale up --login-server=http://<HOST_LAN_IP>:6500 --accept-dns=true
   ```

### Viewing Stack Logs
```bash
# View all logs
./manage.sh logs

# View specific service logs
./manage.sh logs adguardhome
./manage.sh logs torproxy
```

---

## Advanced Configurations

### Using the Tor Proxy

To route a device's browser traffic through Tor, the device **must** be connected to the VPN.

1.  Install a proxy extension (e.g., FoxyProxy or Zero Omega) in your browser.
2.  Configure a new proxy profile:
    *   **Protocol:** HTTP (or SOCKS5)
    *   **Server:** `100.64.0.1` (Your host's VPN IP)
    *   **Port:** `6506` (HTTP) or `6503` (SOCKS5)

### Making the Host an "Exit Node" (Full Tunneling)

By default, this is a "Split Tunnel"—only DNS and Tor proxy requests go to the server. If you are on sketchy public Wi-Fi and want *all* your internet traffic routed through your host server:

1.  Ensure IP forwarding is enabled on your host OS.
    *   Linux: `sysctl -w net.ipv4.ip_forward=1`
    *   macOS: `sysctl -w net.inet.ip.forwarding=1`
2.  Advertise the host as an exit node:
    ```bash
    tailscale up --login-server=http://<HOST_LAN_IP>:6500 --advertise-exit-node --reset
    ```
3.  In your client device's Tailscale app settings, select the host as the "Exit Node". (The provided `config/headscale/acl.json` automatically approves exit node routes).
